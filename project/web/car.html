<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>购物车页面</title>
    <link rel="stylesheet" href="../libs/iconfont/iconfont.css">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/car.css">

</head>

<body>
    <!-- 顶部小导航 -->
    <div class="s_top">
        <div class="container clearfix">
            <ul class="left">
                <li>
                    <i class="iconfont t">&#xe697;</i>
                    送至：
                    <span class="area">上海</span>
                    <i class="iconfont drop">&#xe60a;</i>
                    <!-- 鼠标经过 .drop时再显示 -->
                    <div class="dropdown">
                        <p class="title">请选择所在地区</p>
                        <div class="dropcity clearfix">
                            <label for="">热门省市</label>
                            <span>北京</span>
                            <span>上海</span>
                            <span>天津</span>
                            <span>江苏省</span>
                            <span>浙江省</span>
                            <span>山东省</span>
                            <span>河北省</span>
                            <span>福建省</span>
                        </div>
                        <div class="dropcity clearfix">
                            <label for="">华东</label>
                            <span>上海</span>
                            <span>江苏省</span>
                            <span>浙江省</span>
                            <span>山东省</span>
                            <span>江西省</span>
                            <span>安徽省</span>
                            <span>福建省</span>
                        </div>
                        <div class="dropcity clearfix">
                            <label for="">华南</label>
                            <span>广东省</span>
                            <span>海南区</span>
                            <span>广西区</span>
                        </div>
                        <div class="dropcity clearfix">
                            <label for="">华北</label>
                            <span>北京</span>
                            <span>内蒙古</span>
                            <span>天津</span>
                            <span>河北省</span>
                            <span>山西省</span>
                        </div>
                    </div>
                </li>
                <li>
                    <a href="login.html" class="s_login">登录</a>
                    <span>|</span>
                    <a href="register.html" class="s_register">注册</a>
                </li>
                <li>
                    <i class="iconfont">&#xe61e;</i>
                    我的订单
                </li>
                <li>
                    <i class="iconfont">&#xe65a;</i>
                    收藏本站(Ctrl+D)
                </li>
            </ul>
            <ul class="right">
                <li class="firstli">
                    <i class="iconfont">&#xe641;</i>
                    手机APP
                    <div class="dropdown_p">
                        <div class="dropdown_c clearfix">
                            <div class="item-qrcode">
                                <img src="http://www.lyzb.com/global/images/index2.0/qrcode-1.jpg"
                                    style="height:75px;width:75px">
                            </div>
                            <div class="item-info">
                                <p>集食惠手机客户端</p>
                                <p class="fc-red">手机下单，更多方便、实惠</p>
                                <div>
                                    <img src="http://www.lyzb.com/global/images/index2.0/thumb-iPhone.jpg">
                                    <img src="http://www.lyzb.com/global/images/index2.0/thumb-android.jpg">
                                </div>
                            </div>
                        </div>
                        <div class="dropdown_c clearfix">
                            <div class="item-qrcode">
                                <img src="http://www.lyzb.com/global/images/index2.0/qrcode-1.jpg"
                                    style="height:75px;width:75px">
                            </div>
                            <div class="item-info">
                                <p>集食惠手机网页版</p>
                                <p class="fc-red">手机下单，更多方便、实惠</p>
                                <div>
                                    <img src="http://www.lyzb.com/global/images/index2.0/thumb-iPhone.jpg">
                                    <img src="http://www.lyzb.com/global/images/index2.0/thumb-android.jpg">
                                    <img src="http://www.lyzb.com/global/images/index2.0/thumb-ipad.jpg">
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li class="uli">
                    帮助中心
                    <i class="iconfont">&#xe60a;</i>
                    <div class="drop_u">
                        <a href=""><span>售货服务</span></a>
                        <a href=""><span>会员介绍</span></a>
                        <a href=""><span>支付方式</span></a>
                    </div>
                </li>
                <li>
                    我要兑换
                    <i class="iconfont">&#xe84f;</i>
                </li>
                <li>
                    <i class="iconfont">&#xe634;</i>
                    商家中心
                </li>
            </ul>
        </div>
    </div>
    <!-- 中间logo部分 -->
    <div class="logo">
        <div class="container">
            <img src="http://www.lyzb.com/global/images/index2.0/logo.png" alt="">
            <div class="box">
                <div class="top clearfix">
                    <i class="iconfont mig">&#xe631;</i>
                    <input type="text" placeholder="搜索" name="" id="search">
                    <span>搜索</span>
                </div>
                <div class="bottom clearfix">
                    <a href="">热搜:</a>
                    <a href="">大闸蟹</a>
                    <a href="">蛋卷</a>
                    <a href="">牛奶</a>
                    <a href="">大米</a>
                    <a href="">鸡汤</a>
                    <a href="">食用油</a>
                    <a href="">米粉</a>
                </div>
            </div>
            <div class="shopcar">
                <a href="##">
                    <i class="iconfont">
                        &#xe726;
                        <span id="carcount">0</span>
                    </i>
                    <span class="text">我的购物车&gt;</span>

                </a>
            </div>

        </div>
    </div>


    <!-- 一级二级菜单 -->
    <div class="container">
        <div class="s_menu">
            <span>
                <a href="" class="num11">全部商品分类</a>
                <a href="index.html" class="num22 active">首页</a>
                <a href="list.html" class="num33">所有商品</a>
            </span>

        </div>
    </div>


    <!-- 中间放置表格部分 -->

    <div class="container">
        <table border="1" cellspacing="0" width="800" align="center">
            <thead>
                <tr>
                    <th width="160">图片</th>
                    <th>名字</th>
                    <th width="100">单价</th>
                    <th width="100">数量</th>
                    <th width="100">价格</th>
                    <th width="100">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="5">购物车为空</td>
                </tr>
                <!-- <tr>
                            <td><img src=""></td>
                            <td>名字</td>
                            <td>价格</td>
                            <td><input type="number" value="10"></td>
                            <td >删除</td>
                        </tr> -->
            </tbody>
        </table>
        <h3 class="total">总价是:0元</h3>
        <h3 class="two">点击结算</h3>
    </div>


    <div class="zhifubao" style="width: 200px;height: 200px;position: absolute;z-index: 99;left: 300px;top: 200px;display: none;">
        <img src="../data/images/zhifubao.png" alt="" style="width: 200px;height: 200px;">
    </div>





    <!--    这是底部使用jQuery的ajax请求的主页底部数据渲染 -->
    <div class="lastbottom"></div>
</body>
<script src="../libs/js/jquery.1.12.4.js"></script>
<script src="../js/ajax.3.0.js"></script>
<script src="../js/cookie.js"></script>
<script>
    $(".lastbottom").load("public/bottom.html");


    class Car {
        constructor() {
            this.zhifubao=document.querySelector(".zhifubao");
            //获取元素
            this.carcount=document.querySelector("#carcount");
            this.tbody = document.querySelector("tbody");
            this.totalprice=document.querySelector(".total");
            this.money=document.querySelector(".two");
            this.url = "http://127.0.0.1/js%20project/project/data/goods.json";
            //1.初始渲染页面
            this.load();
            //2.绑定事件
            this.addEvent();
        }
        addEvent() {
            //利用事件委托进行事件绑定
            var that = this;
            //2.1删除
            this.tbody.addEventListener("click", function (eve) {
                if (eve.target.className == "del") {
                     //2.1.1 获取唯一标识，先删除dom元素再删除cookie
                    that.index = eve.target.parentNode.getAttribute("index");
                    eve.target.parentNode.remove();
                    //删除也要重新渲染页面（总价）
                    that.del();
                    that.load();
                }
            })
            //2.2更改数量
            this.tbody.addEventListener("input", function (eve) {
                if (eve.target.className == "num") {
                    //2.2.1获取唯一标识，实时获取输入框的内容（商品数量），并改变相应的cookie里存储的数量
                    that.id = eve.target.parentNode.parentNode.getAttribute("index");
                    that.num=eve.target.value;
                    eve.target.parentNode.nextElementSibling.innerHTML="价格："+that.num*eve.target.parentNode.previousElementSibling.innerHTML+"元";
                    that.changecookie();
                }
            })
            this.money.onclick=function(){
                document.html.style.background="rgba(218, 213, 213,0.8)";
                that.zhifubao.style.display="block";
            }

        }
        //2.2.2 通过遍历改变cookie
        changecookie() {
            for (var i = 0; i < this.goods.length; i++) {
                if (this.goods[i].id == this.id) {
                    this.goods[i].num = this.num;
                }
            }
            
            setCookie(`${this.Lusername}`, JSON.stringify(this.goods),1);
            //重新渲染页面（总价）
            this.display();
        }
        //2.1.2删除cookie
        del() {
            //遍历cookie
            for (var i = 0; i < this.goods.length; i++) {
                if (this.goods[i].id == this.index) {
                    this.goods.splice(i, 1);
                }
            }
            // console.log(this.Lusername);
            setCookie(`${this.Lusername}`, JSON.stringify(this.goods),1);
        }
        //1.1初始渲染页面需要比对数据，读取数据库和cookie中共有的商品，将其渲染到页面上
        load() {
            var that = this;
            //1.2注意读取顺序，在数据库商品请求成功后在读取cookie
            ajax({
                type:"get",
                url:this.url, 
                success:function (res){
                that.res = JSON.parse(res);
                that.msg = localStorage.getItem("loginUser");
                if(that.msg == null) return;
                //获取到了localstorage的用户名

                that.Lusername = JSON.parse(that.msg).user;
                //去获取cookie
               // that.getcookie(that.Lusername);
                if(getCookie(that.Lusername)=="") return;
                that.getcookie(that.Lusername);
            }
        })
        }
        getcookie(name) {
            //这是cookie的数据
            this.goods=JSON.parse(getCookie(name));
            this.display();
        }
        display() {
            var str = "";
            var total=0;
            var sts=0;
           //1.4遍历找相同，相同部分用来渲染页面
            //遍历所有数据
            this.res.forEach((resval) => {
                //遍历cookie中的数据
                this.goods.forEach((goodsval) => {
                    if (resval.goodsId == goodsval.id) {
                        str += `<tr index=${resval.goodsId}>
                                <td><img src="${resval.img}"></td>
                                <td>${resval.title}</td>
                                <td>${resval.price}</td>
                                <td><input class="num" type="number" value="${goodsval.num}" min=1 style="width:50px;border:1px solid #999;"></td>
                                <td>价格:${resval.price*goodsval.num}元</td>
                                <td class="del" style="cursor:pointer;">删除</td>
                            </tr>`;
                        sts++;
                        total += resval.price*goodsval.num;
                        this.carcount.innerHTML=`${sts}`
                    }
                })
            })
            this.tbody.innerHTML = str;
            this.totalprice.innerHTML=`总价是：${total}元`;

           

        }
    }
    new Car();




</script>

</html>